{
    "collab_server" : "",
    "contents" : "---\nlayout: post\ntitle: \"County eBirding: web scraping and web mapping in R\"\npublished: true\nexcerpt: >\n  Scraping the ebird website to find the top hotspot in each county. Covers \n  scraping data from websites with rvest, manipulating spatial data with sf, and \n  making interactive maps with leaflet.\ncategory: r\ntags: r spatial gis ebird\nleaflet: true\n---\n\n[eBird](http://ebird.org) is my go to tool for keeping track of my sightings when I'm out birding. The eBird website is also a great tool for deciding where to go birding. You can find out where particular target birds have been seen recently, or see what other birders have seen in different geographical regions or birding hotspots. Recently, when I've been on a road trip and I pass into a new county, I'll try to stop a least once to go birding. Usually I'll choose a location by looking at nearby [eBird hotspots](https://ebird.org/ebird/hotspots) and picking the one with the most species observed. Part of the fun of this is filling in as many counties as possible on my [eBird profile](https://ebird.org/ebird/profile/MTU0MjQz/US-NY) for my home state, New York.\n\n<div style=\"text-align: center\">\n  <img src=\"/img/ebird-county/county-map.png\" width = \"500\"/>\n</div>\n\nWith this county birding in mind, I decided to make a map of the top eBird hotspot in each county in the US. As always, this is really just an excuse to mess around in R, and this post will cover scraping data from websites with `rvest` and making interactive web maps with `leaflet`. I'll also be using the new R package, `sf`, for working with spatial data.\n\n## Required packages\n\n```{r packages}\nlibrary(tidyverse)\nlibrary(rvest)\nlibrary(stringr)\nlibrary(sf)\nlibrary(leaflet)\nlibrary(leaflet.extras)\nlibrary(USAboundaries)\nlibrary(rnaturalearth)\nlibrary(viridis)\nlibrary(here)\n```\n\n## North American regional stats\n\nFor each country in North America, I drill down to the state and county level and scrape eBird to get the number of species seen and the total number of checklists submitted.\n\n### Country data\n\nCountry data needs to be treated separately, since there is no North America page summarizing the countries, so I manually extract it here. `rvest` makes scraping this sort of data from websites almost trivial. `read_html()` is used to read the HTML source of a page and `html_nodes()` is used extract specific components of the page using CSS selectors. The only slightly tricky part of scraping pages is figuring out what [CSS selector](https://www.w3schools.com/cssref/css_selectors.asp) to use to target a given page component. I typically use Chrome's *Inspect* tool; however, you can also use the [SelectorGadget](http://selectorgadget.com/) Chrome plugin.\n\n```{r country-data, eval = FALSE}\nebird_regions <- data_frame(\n  region_code = c(\"CA\", \"US\", \"MX\"),\n  region_name = c(\"Canada\", \"United States\", \"Mexico\"),\n  region_level = \"country\")\n# function to get number of counts and checklists per country\ncountry_data <- function(country) {\n  # species and checklist  counts\n  base_url <- \"http://ebird.org/ebird/country/%s?yr=all\"\n  page <- sprintf(base_url, country) %>% \n    read_html()\n  counts <- html_nodes(page, \".hs-section-count\") %>% \n    html_text() %>% \n    str_extract(\"[0-9,]+\") %>% \n    parse_number()\n  data_frame(n_species = counts[1], n_checklists = counts[2])\n}\n# apply this to our country list\nebird_regions <- ebird_regions %>% \n  mutate(country_df = map(region_code, country_data)) %>% \n  unnest()\n```\n\n### Extraction function\n\nNow I define a function that extracts all the sub-region data within a region. So I don't hit the eBird website with a bunch of requests all at once, I've used `Sys.sleep()` to pause between each page load.\n\n```{r extraction, eval = FALSE}\nextract_subregion_data <- function(region_code, region_level, sleep = 5) {\n  Sys.sleep(sleep)\n  # species and checklist counts\n  base_url <- \"http://ebird.org/ebird/%s/%s/regions?yr=all\"\n  page <- sprintf(base_url, region_level, region_code) %>% \n    read_html()\n  region_stats <- html_table(page)\n  # skip this region if no data at sub-region\n  if (length(region_stats) == 0) {\n    return(data_frame())\n  }\n  region_stats <- region_stats[[1]] %>% \n    set_names(c(\"rank\", \"region_name\", \"n_species\", \"n_checklists\"))\n  # region codes\n  region_urls <- page %>% \n    html_nodes(\"td a\") %>% \n    html_attr(\"href\")\n  region_codes <- region_urls %>% \n    str_extract(\"[-A-Z0-9]+\\\\?\") %>% \n    str_replace(\"\\\\?\", \"\")\n  region_levels <- region_urls %>% \n    str_extract(\"ebird/[a-z0-9]+\") %>% \n    str_replace(\"ebird/\", \"\")\n  mutate(region_stats, \n         region_code = region_codes, \n         region_level = region_levels) %>% \n    select(region_code, region_name, region_level,\n           n_species, n_checklists) %>% \n    as_tibble()\n}\n```\n\n### State data\n\nI use the above function to grab all the state/province data.\n\n```{r state-data, eval = FALSE}\nstate_df <- map_df(ebird_regions$region_code, extract_subregion_data,\n                   region_level = \"country\")\n```\n\n### County data\n\nAnd the same for county data. Note that Mexico has no data below state.\n\n```{r county-data, eval = FALSE}\ncounty_df <- map_df(state_df$region_code, extract_subregion_data,\n                    region_level = \"subnational1\")\n```\n\n### Combine\n\nCombine the country, state, and county data together into one data frame.\n\n```{r combined, eval = FALSE}\nebird_regions <- bind_rows(ebird_regions, state_df, county_df)\n```\n\n## Top hotspots\n\nNext I want to know the top hotspot in each of these regions. Again, I'll write a function to scrape the eBird website.\n\n```{r extract-top, eval = FALSE} \nextract_top_hotspot <- function(region_code, region_level, sleep = 5) {\n  Sys.sleep(sleep)\n  # species and checklist  counts\n  base_url <- \"http://ebird.org/ebird/%s/%s/hotspots?yr=all\"\n  th <- sprintf(base_url, region_level, region_code) %>% \n    read_html() %>% \n    html_node(\"td a\") %>% \n    html_attr(\"href\") %>% \n    str_extract(\"L[0-9]+\")\n  if (!is.character(th) || length(th) != 1) {\n    return(NA_character_)\n  } else {\n    return(th)\n  }\n}\n```\n\nI call this function for every country, state, and county. This takes awhile...\n\n```{r extract-top-run, eval = FALSE}\nebird_regions <- ebird_regions %>% \n  mutate(top_hotspot = map2_chr(region_code, region_level, extract_top_hotspot))\n```\n\n### Hotspot details\n\nEach hotspot has its own page from which I extract the number of species seen, number of checklists, and location. The following function scrapes a hotspot page. Note here (and earlier in the post), that once you've selected a specific component of the page using `read_nodes()`, you extract data using either `html_text()` or `html_attr()`. `html_text()` grabs the text between a set of tags, while `html_attr()` grabs the value for a particular attribute (e.g. the `href` value of an `<a>` tag).\n\n```{r hotspot-details, eval = FALSE}\nextract_hotspot_data <- function(hotspot_id, sleep = 5) {\n  Sys.sleep(sleep)\n  if (is.na(hotspot_id)) {\n    return(data_frame())\n  }\n  # species and checklist counts\n  base_url <- \"http://ebird.org/ebird/hotspot/%s\"\n  page <- sprintf(base_url, hotspot_id) %>% \n    read_html()\n  # hotspot name\n  hotspot_name <- page %>% \n    html_node(\".hotspot--name\") %>% \n    html_text() %>% \n    trimws()\n  # number of species and checklists\n  hotspot_stats <- page %>% \n    html_nodes(\"span.hs-section-count\") %>% \n    html_text() %>% \n    parse_number()\n  # location\n  hotspot_loc <- page %>% \n    html_nodes(\"div.sub-nat a\") %>% \n    html_attr(\"href\") %>% \n    str_subset(\"google\") %>% \n    str_match(\"ll=([-.0-9]+),([-.0-9]+)$\") %>% \n    `[`(1, 2:3) %>% \n    parse_number()\n  data_frame(hotspot_id = hotspot_id,\n             hotspot_name = hotspot_name,\n             lat = hotspot_loc[1],\n             lng = hotspot_loc[2],\n             hotspot_species = hotspot_stats[1],\n             hotspot_checklists = hotspot_stats[2])\n}\ntop_hotspots <- ebird_regions$top_hotspot %>% \n  unique() %>% \n  map_df(extract_hotspot_data) %>% \n  mutate(hotspot_name = str_replace(hotspot_name, \"\\\\([ .A-z]+ Co\\\\.\\\\)\", \"\"),\n         hotspot_name = trimws(hotspot_name))\n```\n\nNow I bring the hotspot name into the region data and convert the hotspot data frame into a spatial object using the latitude and longitude.\n\n```{r regions-hotspots, eval = FALSE}\nclass(top_hotspots) <- c(\"tbl_df\", \"tbl\", \"data.frame\")\n# regions\nebird_regions <- top_hotspots %>% \n  select(top_hotspot = hotspot_id, hotspot_name) %>% \n  left_join(ebird_regions, ., by = \"top_hotspot\")\n# hotspots\ntop_hotspots <- top_hotspots %>% \n  st_as_sf(coords = c(\"lng\", \"lat\")) %>% \n  st_set_crs(4326)\n```\n\n```{r save, include = FALSE, eval = FALSE}\n# regions\nhere(\"_source\", \"data\", \"ebird-county\", \"ebird_region-stats.rds\") %>% \n  saveRDS(ebird_regions, .)\n# hotspots\nhere(\"_source\", \"data\", \"ebird-county\", \"ebird_top-hotspots.rds\") %>% \n  saveRDS(top_hotspots, .)\n```\n\n```{r read, include = FALSE}\n# regions\nebird_regions <- here(\"_source\", \"data\", \"ebird-county\", \n                      \"ebird_region-stats.rds\") %>% \n  readRDS()\n# hotspots\ntop_hotspots <- here(\"_source\", \"data\", \"ebird-county\", \n                     \"ebird_top-hotspots.rds\") %>% \n  readRDS()\n```\n\n## Maps\n\nNow that I have the data from eBird, I'll make a few maps. First, I'll produce static `ggplot2` choropleth maps of the number of species seen in each state and county. Then I'll produce an interactive `leaflet` map of the top eBird hotspot in each county.\n\n### ggplot2 state map\n\nBefore diving into the county data, I'll map the number of species within each state or province in North America. First, I use `rnaturalearth` to access the geographical boundaries of the states.\n\n```{r state-bounds}\n# lookup table to fix region codes\nmx_codes <- ebird_regions %>% \n  filter(region_level == \"subnational1\", str_detect(region_code, \"^MX\")) %>% \n  select(region_name, region_code) %>% \n  deframe()\n# state boundaries\nna_states <- ne_states(iso_a2 = c(\"CA\", \"US\", \"MX\"), returnclass = \"sf\") %>% \n  mutate(region_code = if_else(iso_a2 == \"MX\", mx_codes[name], iso_3166_2)) %>% \n  select(region_code, country = iso_a2, state = postal)\n# join attribute and spatial data\nebird_states <- ebird_regions %>% \n  filter(region_level == \"subnational1\", region_name != \"Hawaii\") %>% \n  select(region_code, region_name, n_species) %>% \n  inner_join(na_states, ., by = \"region_code\")\n```\n\nNow, I produce a choropleth map of species seen in each state using the new `ggplot2::geom_sf()` ggplot2 geom for working with `sf` objects.\n\n```{r choropleth-species-st, img.link = TRUE, dev = \"png\", fig.width = 960/96, fig.height = 960/96}\n# lambers conformal conic projection\nproj <- paste0(\"+proj=lcc +lat_1=20 +lat_2=60 +lat_0=40 +lon_0=-96 \",\n               \"+x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs\")\nebird_states_aea <- st_transform(ebird_states, crs = proj) %>% \n  st_simplify(preserveTopology = TRUE, dTolerance = 1000)\n# internal country boundary lines\nbl <- ne_download(scale = 110, type = \"admin_0_boundary_lines_land\", \n                  returnclass = \"sf\") %>% \n  st_transform(crs = proj)\nbl <- bl[ebird_states_aea, ]\n# plot\nggplot(ebird_states_aea) + \n  geom_sf(aes(fill = n_species), color = \"white\", size = 0.1) +\n  geom_sf(data = bl, color = \"white\", size = 0.5) +\n  scale_fill_viridis(\"# species\", \n                     limits = c(0, 750), breaks = seq(0, 750, by = 150)) +\n  ggtitle(\"Number of species reported on eBird by state\") +\n  labs(caption = \"Data source: ebird.org\") +\n  theme_void() +\n  theme(plot.title = element_text(size = 18, hjust = 0.5),\n        plot.subtitle = element_text(hjust = 0.5),\n        legend.position = c(0.2, 0.05), legend.justification = c(0, 0), \n        legend.direction = \"vertical\",\n        legend.key.width = unit(0.02, \"npc\"),\n        legend.key.height = unit(0.09, \"npc\"))\n```\n\nIn the US, California (683 species) and Texas (660 species) are, unsurprisingly, the big winners here. Mexico's Oaxaca is overall the most diverse state in North America, with an impressive 742 species reported; more than all of Canada. At the other end, Canada's Nunavut has a paltry 230 species. \n\n### County boundaries\n\nFirst, I'll need to get the boundaries for the counties. The pain here is that county definitions seem to be fluid and eBird doesn't exactly match with any spatial data I've found online. So, I need to combine various sources of data, each of which needs to be manually modified to match eBird. This next bit it a total mess and is probably best skipped over.\n\nFor the US county boundaries, I use the `USAboundaries` package.\n\n```{r county-sf}\nus_counties <- us_counties() %>% \n  st_as_sf() %>% \n  filter(!state_name %in% c(\"Hawaii\", \"Puerto Rico\")) %>% \n  mutate(state = state.abb[match(state_name, state.name)],\n         state = if_else(state_name == \"District of Columbia\", \"DC\", state),\n         region_code = paste(\"US\", state, countyfp, sep = \"-\"),\n         area = st_area(.) %>% as.numeric()) %>% \n  select(region_code, state, area) %>% \n  # adjust counties to match ebird\n  mutate(region_code = recode(region_code,\n                              \"US-MD-510\" = \"US-MD-005\", \n                              \"US-SD-102\" = \"US-SD-113\",\n                              \"US-AK-230\" = \"US-AK-232\", \n                              \"US-AK-105\" = \"US-AK-232\",\n                              \"US-AK-275\" = \"US-AK-280\", \n                              \"US-AK-195\" = \"US-AK-280\",\n                              \"US-AK-198\" = \"US-AK-201\",\n                              \"US-AK-158\" = \"US-AK-102\")) %>% \n  # combine some counties together\n  group_by(region_code, state) %>% \n  # note that summarise calls st_union() on the geometries\n  summarise(area = sum(area)) %>% \n  ungroup()\n```\n\nFor Canadian boundaries, I use the [GADM](http://gadm.org/) level 2 administrative regions, which seems to most closely match eBird. Again, I need to apply some manual modifications, especially for Québec where GADM is outdated.\n\n```{r can, eval = FALSE}\nca_counties <- here(\"_source\", \"data\", \"ebird-county\", \"CAN_adm.gpkg\") %>% \n  read_sf(\"CAN_adm2\") %>% \n  mutate(region_code = str_replace_all(HASC_2, \"\\\\.\", \"-\"),\n         state = str_match(region_code, \"-([A-Z]{2})-\")[, 2],\n         area = st_area(.) %>% as.numeric()) %>% \n  # remove great lakes\n  filter(region_code != \"CA-ON-WB\") %>% \n  # remove counties needing splitting\n  filter(!region_code %in% c(\"CA-QC-SR\", \"CA-QC-FS\", \"CA-QC-MB\", \n                             \"CA-QC-NQ\", \"CA-QC-FR\", \"CA-ON-HN\")) %>% \n  # fix county names\n  mutate(\n    region_code = str_replace(region_code, \"-NF-\", \"-NL-\"),\n    region_code = if_else(NAME_2 == \"Division No. 11\" & \n                            region_code == \"CA-NL-TE\",\n                          \"CA-NL-EL\", region_code),\n    region_code = recode(region_code, \n                         \"CA-QC-CC\" = \"CA-QC-DE\",\n                         \"CA-QC-AM\" = \"CA-QC-APP\")) %>% \n  select(region_code, state, area) %>% \n  # combine split counties\n  group_by(region_code, state) %>% \n  summarize(area = sum(area)) %>% \n  ungroup()\n# split counties using more granular data\ncan_adm3 <- here(\"_source\", \"data\", \"ebird-county\", \"CAN_adm.gpkg\") %>%\n  read_sf(\"CAN_adm3\")\nsr_split <- can_adm3 %>%\n  filter(NAME_2 %in% \"Sept-Rivières--Caniapiscau\") %>%\n  mutate(region_code = if_else(ID_3 %in% c(4436, 4437, 4439, 4440, 4441, 4442,\n                                           4445, 4448, 4451),\n                               \"CA-QC-CAN\", \"CA-QC-SR\"),\n         state = \"QC\",\n         area = st_area(.) %>% as.numeric()) %>%\n  group_by(region_code, state) %>%\n  summarize(area = sum(area)) %>%\n  ungroup()\nfs_split <- can_adm3 %>%\n  filter(NAME_2 %in% \"Le Fjord-du-Saguenay\") %>%\n  mutate(region_code = if_else(ID_3 %in% c(3792, 3794, 3796, 3797, 3801, 3812,\n                                           3813),\n                               \"CA-QC-SAG\", \"CA-QC-FS\"),\n         state = \"QC\",\n         area = st_area(.) %>% as.numeric()) %>%\n  group_by(region_code, state) %>%\n  summarize(area = sum(area)) %>%\n  ungroup()\nmb_split <- can_adm3 %>%\n  filter(NAME_2 %in% \"Minganie--Basse-Côte-Nord\") %>%\n  mutate(region_code = if_else(ID_3 %in% c(4183, 4184, 4185, 4186, 4188,\n                                           4194, 4195, 4198),\n                               \"CA-QC-GSL\", \"CA-QC-MB\"),\n         state = \"QC\",\n         area = st_area(.) %>% as.numeric()) %>%\n  group_by(region_code, state) %>%\n  summarize(area = sum(area)) %>%\n  ungroup()\nnq_split <- can_adm3 %>%\n  filter(NAME_2 %in% \"Nord-du-Québec\") %>%\n  mutate(region_code = if_else(ID_3 %in% c(4249:4255, 4267, 4269:4274,\n                                           4284:4291),\n                               \"CA-QC-JAM\", \"CA-QC-NQ\"),\n         state = \"QC\",\n         area = st_area(.) %>% as.numeric()) %>%\n  group_by(region_code, state) %>%\n  summarize(area = sum(area)) %>%\n  ungroup()\nfr_split <- can_adm3 %>%\n  filter(NAME_2 %in% \"Francheville\") %>%\n  mutate(region_code = if_else(ID_3 %in% c(3446, 3448:3450, 3459, 3460),\n                               \"CA-QC-FR\", \"CA-QC-LCH\"),\n         state = \"QC\",\n         area = st_area(.) %>% as.numeric()) %>%\n  group_by(region_code, state) %>%\n  summarize(area = sum(area)) %>%\n  ungroup()\nhn_split <- can_adm3 %>%\n  filter(NAME_2 %in% \"Haldimand-Norfolk\") %>%\n  mutate(region_code = if_else(ID_3 == 2495, \"CA-ON-NF\", \"CA-ON-HD\"),\n         state = \"ON\",\n         area = st_area(.) %>% as.numeric()) %>%\n  group_by(region_code, state) %>%\n  summarize(area = sum(area)) %>%\n  ungroup()\n# bring everything together\nca_counties <- rbind(ca_counties, sr_split, fs_split, mb_split, nq_split,\n                     fr_split, hn_split) %>%\n  st_set_geometry(\"geometry\") %>%\n  select(-geom)\n```\n\n```{r save-ca, eval = FALSE, include = FALSE}\nhere(\"_source\", \"data\", \"ebird-county\", \"canada_counties.rds\") %>% \n  saveRDS(ca_counties, .)\n```\n\n```{r read-ca, echo = FALSE}\nca_counties <- here(\"_source\", \"data\", \"ebird-county\", \"canada_counties.rds\") %>% \n  readRDS()\n```\n\nMexico is fortunately easy since eBird only goes to state level, which I already have from above.\n\n```{r mex}\nmx_states <- na_states %>% \n  filter(country == \"MX\") %>% \n  mutate(area = st_area(.) %>% as.numeric()) %>% \n  select(region_code, state, area)\n```\n\nAnd I join everything together.\n\n```{r na-counties}\nna_counties <- rbind(us_counties %>% st_transform(crs = 4326), \n                     ca_counties %>% st_transform(crs = 4326),\n                     mx_states %>% st_transform(crs = 4326))\n```\n\nWell, that was a total pain! I now have some sort of Frankenstein map of North American counties, and I can bring in the ebird data.\n\n```{r ebird-sf}\nebird_counties <- ebird_regions %>% \n  filter(\n    (region_level == \"subnational2\" & str_detect(region_code, \"^US|CA\")) | \n      (region_level == \"subnational1\" & str_detect(region_code, \"^MX\"))) %>% \n  inner_join(na_counties, ., by = \"region_code\") %>% \n  select(region_code, state, region_name, area, n_species, n_checklists,\n         top_hotspot, hotspot_name)\n```\n\n```{r save-full, echo = FALSE, eval = FALSE}\nsaveRDS(ebird_counties, \n        here(\"_source\", \"data\", \"ebird-county\", \"ebird-county_sf.rds\"))\n```\n\n### ggplot2 county map\n\nFinally, I produce a choropleth map of species seen in each county using `ggplot2`.\n\n```{r choropleth-species, img.link = TRUE, dev = \"png\", fig.width = 960/96, fig.height = 960/96}\nebird_counties_aea <- st_transform(ebird_counties, crs = proj) %>% \n  # simplify to get smaller file size\n  st_simplify(preserveTopology = TRUE, dTolerance = 1000)\n# plot\nggplot(ebird_counties_aea) + \n  geom_sf(aes(fill = n_species), color = \"white\", size = 0) +\n  geom_sf(data = bl, color = \"white\", size = 0.5) +\n  scale_fill_viridis(\"# species\", \n                     limits = c(0, 750), breaks = seq(0, 750, by = 150)) +\n  ggtitle(\"Number of species reported on eBird\",\n          \"County eBird totals for US/Canada, state totals for Mexico\") +\n  labs(caption = \"Data source: ebird.org\") +\n  theme_void() +\n  theme(plot.title = element_text(size = 18, hjust = 0.5),\n        plot.subtitle = element_text(hjust = 0.5),\n        legend.position = c(0.2, 0.05), legend.justification = c(0, 0), \n        legend.direction = \"vertical\",\n        legend.key.width = unit(0.02, \"npc\"),\n        legend.key.height = unit(0.09, \"npc\"))\n```\n\nAs you'd expect, Mexico is the winner here, both because there is higher bird diversity, but also because the Mexican data are at the state level while the US and Canada data are at the (smaller) county level. In fact, this map is misleading in general because the mapped regions are so variable in size. Within the US, the southern states, and coastal states, have the most species reported.\n\n### Leaflet choropleth map\n\nNow I reproduce the same choropleth map, but using Leaflet to map it interactively. To simplify things, I'll subset the data to just include the contiguous US. Also, I'll throw on a point for the top hotspot in each county.\n\nI want to have popups appear on the map for each county. To do this, I'll create an additional column in the data frame with the HTML for the popup. Here I define a function to generate the popup HTML from data.\n\n```{r pop-maker}\n# polygon popups\npopup_maker <- function(code, name, hs_code, hs_name, n) {\n  link_style <- \"target='_blank' style='text-decoration: none;'\"\n  region_url <- paste0(\"<strong><a href='http://ebird.org/ebird/subnational2/\",\n                       code, \"?yr=all' \", link_style, \">\", \n                       name, \"</a></strong> \", n, \" species\")\n  hs_url <- paste0(\"<strong>Top Hotspot: </strong><a href='\", \n                   \"http://ebird.org/ebird/hotspot/\", hs_code, \"?yr=all' \",\n                   link_style, \">\", hs_name, \"</a>\")\n  paste(region_url, hs_url, sep = \"<br/>\")\n}\n# just contiguous us\nebird_counties_us <- ebird_counties %>% \n  filter(str_detect(region_code, \"^US\"), state != \"AK\") %>% \n  # define popup\n  mutate(region_name = paste(region_name, state, sep = \", \"),\n         popup = popup_maker(region_code, region_name, \n                             top_hotspot, hotspot_name, \n                             n_species))\n# point popups\npopup_maker_hs <- function(code, name, n) {\n  link_style <- \"target='_blank' style='text-decoration: none;'\"\n  hs_url <- paste0(\"<strong><a href='http://ebird.org/ebird/hotspot/\",\n                   code, \"?yr=all' \", link_style, \">\", name, \"</a></strong>\")\n  n_species <- paste(n, \" species\")\n  paste(hs_url, n_species, sep = \"<br/>\")\n}\n# just us hotspots\nhotspots_us <- top_hotspots %>% \n  filter(hotspot_id %in% ebird_counties_us$top_hotspot) %>% \n  mutate(hotspot_name = str_replace(hotspot_name, \"\\\\([ .A-z]+ Co\\\\.\\\\)\", \"\"),\n         hotspot_name = trimws(hotspot_name)) %>% \n  mutate(popup = popup_maker_hs(hotspot_id, hotspot_name, hotspot_species))\n```\n\nThen I generate the Leaflet map.\n\n```{r leaflet, eval = FALSE}\n# color palette\np <- colorNumeric(\"viridis\", domain = ebird_counties_us$n_species)\nleaflet(ebird_counties_us) %>%\n  addTiles() %>% \n  addFullscreenControl() %>% \n  addPolygons(color = \"#444444\", weight = 0.25, smoothFactor = 0.5,\n              opacity = 1.0, fillOpacity = 0.7,\n              fillColor = ~ p(n_species),\n              popup = ~ popup) %>% \n  addLegend(\"bottomright\", pal = p, values = ~ n_species,\n            title = \"# species\", opacity = 1) %>% \n  addCircles(data = hotspots_us, color = \"#444444\",\n             radius = 2000, stroke = FALSE, fillOpacity = 1,\n             group = \"Hotspots\", popup = ~ popup) %>% \n  addLayersControl(overlayGroups = \"Hotspots\",\n                   options = layersControlOptions(collapsed = FALSE))\n```\n\n\n<iframe src=\"/assets/leaflet/ebird-county_counties.html\" style=\"border: none; width: 800px; height: 500px\"></iframe>\n<a href=\"/assets/leaflet/ebird-county_counties.html\" target=\"_blank\"><strong>Fullscreen</strong></a> | Data source: [eBird](http://ebird.org/)\n\n### Leaflet hotspot map\n\nFinally, I produce a similar map, this time highlighting the hotspots rather than the counties. For this one, I'll zoom in on the NY, otherwise the points overlap and look messy.\n\n```{r leaflet-hs, eval = FALSE}\n# color palette\np <- colorNumeric(\"inferno\", domain = hotspots_us$hotspot_species)\nleaflet(hotspots_us) %>%\n  addProviderTiles(\"Stamen.Terrain\") %>% \n  # focus on ne us\n  fitBounds(-79, 41, -72, 45) %>%\n  addFullscreenControl() %>% \n  # county boundaries\n  addPolygons(data = ebird_counties_us,\n              color = \"#444444\", weight = 0.5, smoothFactor = 0.5,\n              opacity = 1, fillColor = \"#AAAAAA\", fillOpacity = 0.1) %>%\n  # hotspots\n  addCircleMarkers(data = hotspots_us, color = ~ p(hotspot_species),\n                   radius = 5, stroke = FALSE, fillOpacity = 1,\n                   popup = ~ popup) %>% \n  addLegend(\"bottomright\", pal = p, values = ~ hotspot_species,\n            title = \"# species\", opacity = 1)\n```\n\n```{r save-leaflet, include = FALSE, eval = FALSE}\nlib <- here(\"assets\", \"leaflet\", \"lib\")\nhere(\"assets\", \"leaflet\", \"ebird-county_hotspots.html\") %>% \n  htmlwidgets::saveWidget(x, ., libdir = lib)\n```\n\nThe fullscreen map is viewable <a href=\"/assets/leaflet/ebird-county_hotspots.html\" target=\"_blank\"><strong>here</strong></a>.",
    "created" : 1499887625564.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1831569350",
    "id" : "16EE4A0B",
    "lastKnownWriteTime" : 1499892535,
    "last_content_update" : 1499892535672,
    "path" : "~/projects/mstrimas.github.io/_source/2017-07-10-ebird-county.rmd",
    "project_path" : "_source/2017-07-10-ebird-county.rmd",
    "properties" : {
        "chunk_output_type" : "console"
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}